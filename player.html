<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Universal Player Rev4</title>

<!--
UNIVERSAL PLAYER (Video.js primary, Clappr fallback)
===================================================

Purpose
-------
This page plays a single HLS stream (an .m3u8 URL) in a kiosk-friendly, full-bleed frame.
It tries Video.js first (generally more robust for long-running HLS), and if playback errors
or stalls, it automatically falls back to Clappr.

How you use it
--------------
1) Save this file as:
   /shulboard/player.html   (or another name, but update your wallboard URLs accordingly)

2) In your wallboard.html, each tile should iframe this player, passing the stream URL in
   the query string as a URL-encoded value:

   <iframe src="https://solutionssquad.github.io/shulboard/player.html?src=ENCODED_M3U8_URL&fit=contain&reload=60"></iframe>

3) IMPORTANT: The src= parameter MUST be URL-encoded.
   That means characters like ":" "/" "?" "&" must be encoded so they do not break the query string.

   Example encoding:
   https://example.com/live/master.m3u8
   becomes
   https%3A%2F%2Fexample.com%2Flive%2Fmaster.m3u8

How to URL-encode quickly
-------------------------
Option A (Chrome DevTools Console on any page):
  encodeURIComponent("https://example.com/live/master.m3u8")

Option B (Windows PowerShell):
  [uri]::EscapeDataString("https://example.com/live/master.m3u8")

Option C (Online encoder):
  Any URL encoder works. Encode ONLY the m3u8 URL that you put after src=

Supported Query Parameters
--------------------------
Required:
  src     URL-encoded HLS .m3u8 stream URL

Optional:
  fit     contain | cover
          contain = no cropping, may show black bars if aspect does not match the tile
          cover   = crop-fill, no bars, edges may be cut off

  muted   1 | 0
          1 = muted (recommended for autoplay)
          0 = not muted (may require user gesture depending on browser policy)

  reload  number (minutes)
          0 = disable periodic reload
          60 = reload this tile every 60 minutes (helps long-run stability)

Examples
--------
Example 1: Simple tile, keep full frame (no crop)
  https://solutionssquad.github.io/shulboard/player.html?src=https%3A%2F%2Fabcnews-streams.akamaized.net%2Fhls%2Flive%2F2023566%2Fabcnewshudson7%2Fmaster.m3u8&fit=contain

Example 2: Crop-fill to eliminate bars, reload every 45 minutes
  https://solutionssquad.github.io/shulboard/player.html?src=https%3A%2F%2Ffox-foxnewsnow-vizio.amagi.tv%2Fplaylist.m3u8&fit=cover&reload=45

Example 3: Unmuted (not recommended unless you need audio)
  https://solutionssquad.github.io/shulboard/player.html?src=https%3A%2F%2Fexample.com%2Flive%2Fmaster.m3u8&muted=0&fit=contain

Integrating with your URL-variable wallboard
--------------------------------------------
If your wallboard uses a URL map like:

  const URLS = {
    URL7: "https://solutionssquad.github.io/shulboard/player.html?src=ENCODED&fit=contain&reload=60"
  };

Then your tile can be:

  <iframe data-src="URL7"></iframe>

and your wallboard JS assigns iframe.src from URLS.

Notes / Troubleshooting
-----------------------
- If the stream is tokenized/signed, the .m3u8 may expire. When it expires, the player will fail
  and reload/fallback will not fix it; you must update the stream URL.
- Autoplay usually requires muted=1.
- If you see black bars:
  - Prefer fixing tile aspect ratio in wallboard, OR use fit=cover.
- If a stream fails in Video.js, this page automatically tries Clappr.
  If it also fails in Clappr, the tile will reload the whole page after a short delay.

Versioning
----------
Update the <title> with Rev+1 each time you change this file.
-->

<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/clappr/clappr@latest/dist/clappr.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: #000;
  overflow: hidden;
}

#vjs, #clappr {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  background: #000;
}

#clappr { display: none; }

.video-js,
.video-js .vjs-tech {
  width: 100% !important;
  height: 100% !important;
}

.video-js .vjs-tech,
#clappr video {
  object-fit: var(--fit, contain);
  background: #000;
}

/* Kiosk: hide Video.js UI */
.vjs-control-bar,
.vjs-big-play-button,
.vjs-loading-spinner,
.vjs-modal-dialog {
  display: none !important;
}

/* Kiosk: hide Clappr overlays if present */
#clappr .media-control,
#clappr .spinner {
  display: none !important;
}
</style>
</head>

<body>
<video id="vjs" class="video-js" autoplay playsinline muted preload="auto"></video>
<div id="clappr"></div>

<script>
function param(name, def) {
  const u = new URL(location.href);
  return u.searchParams.get(name) ?? def;
}

const src = param("src", "");
if (!src) {
  document.body.innerHTML =
    "<div style='color:#fff;font:16px Arial;padding:12px'>" +
    "Missing required parameter: ?src= (URL-encoded .m3u8 URL)" +
    "</div>";
  throw new Error("Missing src");
}

const fit = (param("fit", "contain") || "contain").toLowerCase();
document.documentElement.style.setProperty("--fit", fit === "cover" ? "cover" : "contain");

const muted = param("muted", "1") !== "0";
const reloadMin = parseInt(param("reload", "0"), 10) || 0;

let using = "vjs";
let vjsPlayer = null;
let clapprPlayer = null;

function hardReloadSoon(ms) {
  setTimeout(() => location.reload(), ms);
}

function showVjs() {
  using = "vjs";
  document.getElementById("vjs").style.display = "block";
  document.getElementById("clappr").style.display = "none";
}

function showClappr() {
  using = "clappr";
  document.getElementById("vjs").style.display = "none";
  document.getElementById("clappr").style.display = "block";
}

function destroyVjs() {
  try {
    if (vjsPlayer) {
      vjsPlayer.dispose();
      vjsPlayer = null;
    }
  } catch (e) {}
}

function destroyClappr() {
  try {
    if (clapprPlayer) {
      clapprPlayer.destroy();
      clapprPlayer = null;
    }
  } catch (e) {}
  document.getElementById("clappr").innerHTML = "";
}

function startClappr() {
  destroyVjs();
  showClappr();

  clapprPlayer = new Clappr.Player({
    source: src,
    parentId: "#clappr",
    autoPlay: true,
    mute: muted,
    chromeless: true,
    loop: true,
    width: "100%",
    height: "100%",
    playback: { playInline: true }
  });

  if (clapprPlayer && clapprPlayer.on) {
    clapprPlayer.on(Clappr.Events.PLAYER_ERROR, () => hardReloadSoon(3000));
  }
}

function startVjs() {
  destroyClappr();
  showVjs();

  try { document.getElementById("vjs").muted = muted; } catch (e) {}

  vjsPlayer = videojs("vjs", {
    autoplay: true,
    muted: muted,
    controls: false,
    liveui: true,
    preload: "auto",
    sources: [{ src, type: "application/x-mpegURL" }]
  });

  let triedFallback = false;

  function fallbackToClapprSoon(ms) {
    if (triedFallback) return;
    triedFallback = true;
    setTimeout(() => startClappr(), ms);
  }

  vjsPlayer.on("error", () => fallbackToClapprSoon(500));
  vjsPlayer.on("stalled", () => fallbackToClapprSoon(1500));

  // Detect stuck playback: if time does not advance across checks, fallback
  let lastTime = null;
  let unchangedCount = 0;

  setInterval(() => {
    if (!vjsPlayer || using !== "vjs") return;
    const t = vjsPlayer.currentTime();
    if (typeof t !== "number" || isNaN(t)) return;

    if (lastTime === null) {
      lastTime = t;
      return;
    }

    if (t === lastTime) {
      unchangedCount += 1;
      if (unchangedCount >= 2) fallbackToClapprSoon(500);
    } else {
      unchangedCount = 0;
      lastTime = t;
    }
  }, 15000);
}

startVjs();

if (reloadMin > 0) {
  setTimeout(() => location.reload(), reloadMin * 60 * 1000);
}
</script>

</body>
</html>
